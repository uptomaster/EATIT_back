<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="myReview">

	<!--내가 작성한 리뷰 조회  -->
	<select id="myReviewSelect" resultType="ReviewWriteDTO">
	<![CDATA[
	 SELECT * FROM (
    SELECT ROWNUM AS RNUM, SUBQUERY.*
    FROM (
		  SELECT 
			  (SELECT S.STORE_NAME FROM tbl_store s WHERE s.BUSINESS_NUMBER = r.BUSINESS_NUMBER )AS storeName,
				(SELECT CASE I.ITEM_TYPE
			                WHEN 'FOOD' THEN '음식'
			                WHEN 'INGREDIENT' THEN '재료'
			                ELSE I.ITEM_TYPE
			            END 
			    FROM TBL_ITEM I  WHERE I.ITEM_NUMBER = OI.ITEM_NUMBER) AS itemType,		    
			    (SELECT I.ITEM_NAME FROM TBL_ITEM I  WHERE I.ITEM_NUMBER = OI.ITEM_NUMBER) AS itemName,
			    R.REVIEW_CONTENT AS reviewContent,
			    OI.ORDER_ITEM_QUANTITY AS orderItemQuantity,
			    OI.ORDER_ITEM_UNIT_PRICE AS orderItemUnitPrice,
			    R.REVIEW_RATING AS reviewRating,
			    TO_CHAR(R.REVIEW_CREATE_DATE, 'YYYY-MM-DD') AS reviewCreateDate
			FROM TBL_REVIEW R
			INNER JOIN TBL_ORDER_ITEM OI ON r.ORDERS_NUMBER = OI.ORDERS_NUMBER
			WHERE R.MEMBER_NUMBER = #{memberNumber}
		) SUBQUERY
  )WHERE RNUM BETWEEN #{startRow} AND #{endRow}
	]]>
	</select>
	
	<!--내가 작성한 리뷰 총 개수 조회  -->
	<select id="myReviewCount" resultType="int">
	<![CDATA[
	 SELECT count(*) FROM (
    SELECT ROWNUM AS RNUM, SUBQUERY.*
    FROM (
      SELECT REVIEW_NUMBER,ORDERS_NUMBER,BUSINESS_NUMBER,MEMBER_NUMBER,REVIEW_RATING,REVIEW_CONTENT,REVIEW_CREATE_DATE
      FROM TBL_REVIEW
      WHERE MEMBER_NUMBER = #{memberNumber}
      ORDER BY REVIEW_CREATE_DATE DESC
    ) SUBQUERY
  )WHERE RNUM BETWEEN #{startRow} AND #{endRow}
	]]>
	</select>
	
	<!-- 내가 구매한 상품 리뷰 작성 -->
	<insert id="myReviewInsert" parameterType="ReviewWriteDTO">
	   <selectKey keyProperty="reviewNumber" resultType="int" order="BEFORE">
	        SELECT SEQ_REVIEW_NUMBER.NEXTVAL FROM DUAL
	   </selectKey>
	  INSERT INTO TBL_REVIEW (REVIEW_NUMBER,ORDERS_NUMBER,BUSINESS_NUMBER,MEMBER_NUMBER,REVIEW_RATING,REVIEW_CONTENT,REVIEW_CREATE_DATE)
	  VALUES (
	    #{reviewNumber},#{ordersNumber},#{businessNumber},#{memberNumber},#{reviewRating},#{reviewContent},SYSDATE
	  )
	</insert>
	
	<!-- 주문 단건 조회  -->
	<select id="selectOneOrder" resultType="ReviewWriteDTO">
	<![CDATA[
		SELECT
			o.orders_date                                   AS ordersDate,
			(oi.order_item_unit_price * oi.order_item_quantity) AS ordersTotalAmount,
			oi.order_item_quantity                          AS orderItemQuantity,
			i.item_type AS itemType,
			i.item_name                                     AS itemName,
			(SELECT s.store_name
			       FROM TBL_STORE s
			      WHERE s.business_number = i.business_number)  AS storeName,
			oi.ORDER_ITEM_UNIT_PRICE						AS orderItemUnitPrice,
			o.BUSINESS_NUMBER 			AS businessNumber,
			o.orders_number 				AS ordersNumber,
			o.orders_member_number	AS memberNumber
		FROM TBL_ORDERS o
		JOIN TBL_ORDER_ITEM oi ON oi.orders_number = o.orders_number
		JOIN TBL_ITEM i ON i.item_number = oi.item_number
		WHERE o.ORDERS_NUMBER = #{ordersNumber}
		]]>
	</select>
	
	<!-- 리뷰 작성용 전체 주문 조회 (페이지네이션 처리 X) -->
	<select id="myOrderSelectAll" parameterType="map" resultType="MyPurchaseDTO">
	    <![CDATA[
	        SELECT
	            o.orders_date AS ordersDate,
	            (SELECT s.store_name 
	             FROM TBL_STORE s 
	             WHERE s.business_number = i.business_number) AS storeName,
	            i.item_name AS itemName,
	            oi.order_item_quantity AS orderItemQuantity,
	            oi.order_item_unit_price AS orderItemUnitPrice,
	            (oi.order_item_unit_price * oi.order_item_quantity) AS ordersTotalAmount,
	            o.orders_number AS ordersNumber,
	        FROM TBL_ORDERS o
	        JOIN TBL_ORDER_ITEM oi ON oi.orders_number = o.orders_number
	        JOIN TBL_ITEM i ON i.item_number = oi.item_number
	        WHERE o.orders_member_number = #{memberNumber}
	          AND o.orders_number = #{ordersNumber}
	        ORDER BY oi.order_item_number ASC
	    ]]>
	</select>
	<!-- 리뷰가 작성되 있는지 확인 -->
	<select id="hasReview" parameterType="map" resultType="int">
	    SELECT COUNT(1)
	    FROM TBL_REVIEW
	    WHERE orders_number = #{ordersNumber}
	      AND member_number = #{memberNumber}
	</select>

</mapper>