<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="seller">

<!-- 마이페이지 진입전 비밀번호 확인 -->
<select id="chkPw" parameterType="map" resultType="int">
    <![CDATA[
      SELECT COUNT(1)
      FROM TBL_MEMBER
      WHERE MEMBER_PASSWORD = #{memberPassword}
        AND MEMBER_NUMBER   = #{memberNumber}
    ]]>
  </select>

<!-- 사업자번호 조회 -->
	<select id="getBusinessNumber" parameterType="int" resultType="String">
		<![CDATA[
		SELECT
		s.business_number
		FROM TBL_MEMBER m
		INNER JOIN TBL_SELLER_MEMBER sm
			ON sm.member_number = m.MEMBER_NUMBER
		INNER JOIN TBL_STORE s
			ON s.member_number = sm.MEMBER_NUMBER
		WHERE m.member_number = #{memberNumber}
		]]>
	</select>
<!-- 내 정보 조회 -->
	<select id="selectSellerinfo" parameterType="int" resultType="SellerInfoDTO">
	<![CDATA[
	 SELECT
       m.member_number                      AS memberNumber,
       m.member_id                          AS memberId,
       m.member_password                    AS memberPassword,
       sm.seller_name                       AS sellerName,
       TO_CHAR(sm.seller_birthdate,'YYYY-MM-DD') AS sellerBirthdate,
       sm.seller_phone_number               AS sellerPhoneNumber,
       TO_CHAR(sm.seller_updated_date,'YYYY-MM-DD') AS sellerUpdatedDate,
       s.business_number                    AS businessNumber,
       s.store_name                         AS storeName,
       TO_CHAR(s.store_open_date,'YYYY-MM-DD') AS storeOpenDate,
       s.store_tel                          AS storeTel,
       s.store_address                      AS storeAddress,
       s.store_address_detail               AS storeAddressDetail,
       s.store_zip_code                     AS storeZipCode,
       s.store_open_time                    AS storeOpenTime,
       s.store_close_time                   AS storeCloseTime,
       s.store_latitude                     AS storeLatitude,
       s.store_longitude                    AS storeLongitude
    FROM TBL_MEMBER m
    INNER JOIN TBL_SELLER_MEMBER sm
      ON sm.member_number = m.MEMBER_NUMBER
    INNER JOIN TBL_STORE s
      ON s.member_number = sm.MEMBER_NUMBER
    WHERE m.member_number = #{memberNumber}
	]]>
	</select>
	<!-- =========== 개인 정보 수정 ============== -->
		<!-- 비밀번호 확인 -->
	<select id="checkPassword" parameterType="map" resultType="int">
	   <![CDATA[
      SELECT COUNT(1)
      FROM TBL_MEMBER
      WHERE MEMBER_NUMBER   = #{memberNumber}
        AND MEMBER_PASSWORD = #{memberPassword}
    ]]>
	</select>
	
	<!-- 비밀번호 변경 -->
	<update id="updatePassword" parameterType="map">
	     <![CDATA[
      UPDATE TBL_MEMBER
         SET MEMBER_PASSWORD = #{memberPassword}
       WHERE MEMBER_NUMBER   = #{memberNumber}
    ]]>
	</update>
	
	<!-- 전화번호 변경 -->
	<update id="updatePhone" parameterType="map">
    <![CDATA[
     UPDATE TBL_SELLER_MEMBER
        SET SELLER_PHONE_NUMBER = #{memberPhone}
      WHERE MEMBER_NUMBER       = #{memberNumber}
    ]]>
	</update>
	
	<!-- 영업시간 변경 -->
	<update id="updateStoreTime" parameterType="StoreDTO">
    UPDATE TBL_STORE
       SET STORE_OPEN_TIME  = #{storeOpenTime},
           STORE_CLOSE_TIME = #{storeCloseTime}
     WHERE BUSINESS_NUMBER  = #{businessNumber}
	</update>
	
	<update id="updateStoreAddressGeo" parameterType="StoreDTO">
	  UPDATE TBL_STORE
	     SET STORE_ZIP_CODE       = #{storeZipCode}
	       , STORE_ADDRESS        = #{storeAddress}
	       , STORE_ADDRESS_DETAIL = #{storeAddressDetail}
	       , STORE_LONGITUDE      = #{longitude}   
	       , STORE_LATITUDE       = #{latitude}
	   WHERE BUSINESS_NUMBER      = #{businessNumber}
	</update>

	<!-- =========== 회원 탈퇴 ========== -->	
<!--  1댓글 삭제 (작성자 기준) -->
<delete id="deleteUserComments" parameterType="int">
    DELETE FROM TBL_COMMENT
    WHERE MEMBER_NUMBER = #{memberNumber}
</delete>

<!--  2리뷰 삭제 (작성자 기준) -->
<delete id="deleteUserReviews" parameterType="int">
    DELETE FROM TBL_REVIEW
    WHERE MEMBER_NUMBER = #{memberNumber}
</delete>

<!--  3게시글 삭제 (작성자 기준) -->
<delete id="deleteUserPosts" parameterType="int">
    DELETE FROM TBL_POST
    WHERE MEMBER_NUMBER = #{memberNumber}
</delete>

<!--  4원산지 삭제 (가게 기준) -->
<delete id="deleteStoreOrigins" parameterType="string">
    DELETE FROM TBL_ORIGIN
    WHERE BUSINESS_NUMBER = #{businessNumber}
</delete>

<!--  5메뉴 삭제 (사업자 기준) -->
<delete id="deleteStoreItems" parameterType="string">
    DELETE FROM TBL_ITEM
    WHERE BUSINESS_NUMBER = #{businessNumber}
</delete>

<!--  6가게 삭제 (판매자 번호 기준) -->
<delete id="deleteStore" parameterType="int">
    DELETE FROM TBL_STORE
    WHERE MEMBER_NUMBER = #{memberNumber}
</delete>

<!--  7판매자 삭제 -->
<delete id="deleteSeller" parameterType="int">
    DELETE FROM TBL_SELLER_MEMBER
    WHERE MEMBER_NUMBER = #{memberNumber}
</delete>

<!--  8회원 삭제 (최종적으로 계정 삭제) -->
<delete id="deleteMember" parameterType="int">
    DELETE FROM TBL_MEMBER
    WHERE MEMBER_NUMBER = #{memberNumber}
</delete>

    
    
	<!-- =========== 리뷰 작성 ========== -->	
  <!-- 리뷰 저장 -->
  <insert id="insertReview" parameterType="ReviewDTO">
    <selectKey keyProperty="reviewNumber" 
    
    
    resultType="int" order="BEFORE">
      SELECT SEQ_REVIEW_NUMBER.NEXTVAL FROM DUAL
    </selectKey>
    INSERT INTO TBL_REVIEW(
      REVIEW_NUMBER, MEMBER_NUMBER, ORDERS_NUMBER, BUSINESS_NUMBER, ITEM_NUMBER,
      REVIEW_RATING, REVIEW_CONTENT, REVIEW_CREATE_DATE
    ) VALUES (
      #{reviewNumber}, #{memberNumber}, #{ordersNumber}, #{businessNumber}, #{itemNumber},
      #{reviewRating}, #{reviewContent}, SYSDATE
    )
  </insert>
  
    <!-- 이미 리뷰 존재 여부 -->
  <select id="existsReview" parameterType="map" resultType="int">
    SELECT COUNT(*)
    FROM TBL_REVIEW
    WHERE ORDERS_NUMBER = #{ordersNumber}
      AND ITEM_NUMBER   = #{itemNumber}
      AND MEMBER_NUMBER = #{memberNumber}
  </select>

	<!-- 리뷰 작성 여부 확인 -->
</mapper>